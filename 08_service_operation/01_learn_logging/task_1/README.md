# 課題1

## Table of Contents
<!-- START doctoc -->
<!-- END doctoc -->

## ログレベルとは

|レベル|概要|
|--------|----------------|
|DEBUG|プログラム内で起こっていることに関連するあらゆる情報。プログラマーがデバッグのために書いたメッセージであることが多い|
|INFO|ユーザーが開始したアクションや、スケジュールされたタスクの実行。システムのスタートアップやシャットダウンなどのシステム操作。|
|WARN|将来的にエラーになる可能性のある状態。ライブラリの廃止に関する警告、使用可能なリソースの不足、パフォーマンスの低下など|
|ERROR|すべてのエラー状態|
|FATAL|システムをシャットダウンさせる全てのエラー状態。例えばシステムの軌道に32GBのメモリが必要だが、16GBしか利用できない場合、プログラムはFATALエラーメッセージを記録し、直ちに終了する|

## アプリケーションログに含めるべき情報

- 良いログメッセージ
  - ログを見る人は、そのログメッセージしか見ないという前提で、全てのログメッセージは書かれるべき
  - ログを読む人が理解できるように、ログメッセージに必要な文脈を詰め込む
  - アプリケーションログに含めるべき内容
    - いつ：ログの日付と時刻（国際形式）
    - どこ：アプリケーション識別子、アドレスなど
    - だれ：送信元アドレス、ユーザーID
    - 何：イベントの種類、重要度、説明など
  - 良いエラーメッセージの要素
    - 何のアクションが実行されたのか
    - そのアクションの期待される結果は何か
    - そのアクションの実際の結果は何か
    - とるべき修復手順は何か
    - （もしあれば）このエラーによって引き起こされる潜在的な結果は何か

```json
// 例：注文処理のシステム
{
  "timestamp": "2019-08-01:23:52:44",
  "level": "INFO",
  "order_id": 25521,  // 注文詳細を知りたい場合、このIDでさらにフィルタリングする
  "state": "IN PROCESS",
  "message": "Paymentverified",
  "subsystem": "payments.processors.credit_card"
}
```

- 含めるべきでない情報
  - 法的に認可されていない限り、データをログに記録しない
  - 以下のような情報は、直接記録せずに、削除、マスク、サニタイズ、ハッシュ、暗号化などをする必要がある
    - アプリケーションのソースコード
    - セッション識別値
    - アクセストークン
    - 認証パスワード
    - データベース接続文字列
    - 暗号化キー、マスターシークレット
    - 業務上の機密情報
    - 特定地域で収集が違法な情報
    - ユーザーが収集をオプトアウトした情報

## パースしやすいログメッセージ

- 以下のようなメッセージはパースしづらい
  - 正規表現が必要になるため

```log
log.info("User {} plays {} in game {}", userId, card, gameId;
```

```log
2013-01-12 17:49:37,656 [T1] INFO  c.d.g.UserRequest  User 1334563 plays 4 of spades in game 23425656
```

- フォーマットはJSONだと良い
  - いろんなログ集約サービスで使用やすいため

```log
2013-01-12 17:49:37,656 [T1] INFO  c.d.g.UserRequest  User plays {'user':1334563, 'card':'4 of spade', 'game':23425656}
```

## ログの種類

|種類|概要|
|----------|--------------|
|アクセスログ|PCやサーバーへの接続履歴。特にWebサーバへの通信記録を指す|
|アプリケーションログ|ソフトウェアアプリケーションによって記録されるイベント記録。エラーやinfoや警告を含む|
|エラーログ|エラーが発生したときに記録される|
|（フロントエンドの）ユーザーログ|ユーザーのアプリケーション上の操作を記録する|
|データベースのクエリログ|DBへの接続、解除、実行されたクエリを記録する|

## ログローテーションとは

- 現時点のログをアーカイブすること
  - 新しいログを開始し、古いログを削除する
- 定期的に削除することで、ログの肥大化を防ぐ

## ログに関する整理

- ログ集約
  - ログが伝える情報量は、プロセスフロー全体を表していることがよくある
  - 集約することで、複数の関心事に関連したアラートや監視が可能になる
  - ログは必ず構造化すべき
    - 構造化すると、フィールドや値を取得するための複雑で壊れやすい正規表現が不要になるので、ログの取り込みが簡単になる

- ログについて知っておくべきこと
  1. 自分でログメッセージを書かずに、ライブラリなどを使用する
  2. 適切なログレベルを設定する
  3. 適切ねログカテゴリを設定する
  4. 意味のあるログメッセージを書く
  5. 英語でログメッセージを書く
  6. ログメッセージに文脈を追加する
  7. パースしやすいフォーマットで記録する
  8. 人間がよめるログにする
  9. ログに記録しすぎたり、少なすぎたりしない
  10. 読み手のことを考える
  11. トラブルシューティング目的だけでログを取らない
  12. 特定のベンダーのみに縛られないようにする
  13. 機密情報を記録しないように

## 参考

- （書籍）[システム運用アンチパターン](https://www.oreilly.co.jp/books/9784873119847/)
- [OWASP Cheat Sheet Series Logging Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Logging_Cheat_Sheet.html)
- [Logging Best Practices: The 13 You Should Know](https://www.dataset.com/blog/the-10-commandments-of-logging/)
- [はじめてのログローテート](https://qiita.com/matsuda-hiroki/items/9802538432b9dbf03ab0)
- [Log Rotation - 2020 - BogoToBogo](https://www.bogotobogo.com/DevOps/DevOps-Sys-Admin-Interview-Questions-Log-Rotation.php#:~:text=%22Log%20rotation%22%20refers%20to%20the,log%2C%20and%20deleting%20older%20logs.)