# 課題 1

## Table of Contents

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<details>
<summary>Details</summary>

- [質問 1](#%E8%B3%AA%E5%95%8F-1)
  - [回答](#%E5%9B%9E%E7%AD%94)
- [質問 2](#%E8%B3%AA%E5%95%8F-2)
  - [回答](#%E5%9B%9E%E7%AD%94-1)
- [質問 3](#%E8%B3%AA%E5%95%8F-3)
  - [回答](#%E5%9B%9E%E7%AD%94-2)
- [疑問](#%E7%96%91%E5%95%8F)
- [参考](#%E5%8F%82%E8%80%83)

</details>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## 質問 1

> スナップショットテストとはなんでしょうか？説明してください

### 回答

- 自動でアプリの内部状態を記録し、正しい状態と比較・差分検出をする仕組み

- 導入によるメリット
  - エンジニアのみで UI のリグレッションテストが容易にできるようになり、修正箇所もわかりやすいため、UI のデグレードが発生しづらい
  - 意図しないデザインの崩れを自動で検出することができる
  - 手動で UI の状態を再現したり、撮影することが不要になる
  - UI のテストのみを集中して行うことができる
    - 実際のブラウザやスマホなどの画面ではなく、コマンドラインで実行されるため、ビルドを待ったり、ページを読み込むなどを行う必要がない。そのような UI 以外の不安定な要素に UI のテストが左右されることがない

## 質問 2

> スナップショットテストを用いることで、どのような不具合が防止できるでしょうか？3 つほど例を挙げてみてください

### 回答

- 意図しない表示崩れが起きるなどのデグレード
  - 目視では見逃しやすい UI やレイアウトのデグレを検出できる
    - 例えば
      - 画面数が多く、特定の画面の確認が漏れてしまう
      - 再現困難な画面の確認が漏れてしまう
      - レイアウトが複雑だったり、数 pt の違いなど目視では確認できないレベルの違いを見逃してしまう

## 質問 3

> スナップショットテストでは防止できない不具合もあります。3 つほど例を挙げてください

### 回答

- 比較する以前のスナップショットが期待している状態とは異なる場合
  - スナップショットテストは以前のものと現時点のスナップショットを比較することで差分を検出する仕組みであり、それが期待されている出力であるかどうかに関しては何も示さないため
- 動的なコンテンツをテストしたい場合
  - 動的にコンテンツが表示される（例えば動的に多言語翻訳を行うツールを使用している場合などは、毎回翻訳結果が同じとは限らない場合がある）、JavaScript や CSS のアニメーションにより時間と共に表示が変化するなど、動的なコンテンツの表示をテストする場合、比較元のデータと一致しないため、スナップショットテストが失敗してしまう
  - ただし、こういった動的なコンテンツのスナップショットテストを可能にするためのツールも存在している。
    - Jest では、動的要素を識別するためのスナップショットを作成する時に使用可能な asymmetric matchers を提供している。これはスナップショットが作成された時の特定の値ではなく、特定のタイプの任意の値を受け入れるように Jest に指示している
    ```javascript
    expect(userData).toMatchSnapshot({
      createdAt: expect.any(Date),
      id: expect.any(Number),
    });
    ```
    - Percy や Chromatic は、 JavaScript や CSS アニメーションなどの動的コンテンツを処理するための手法があるが、開発者の介入が必要な場合もある

## 疑問

- 過去のスナップショットをフォルダの移動、リネームなどをせずに取っておくことはできないのか？（未調査）
  - 意図した変更を行った場合、`yarn test`を再度実行する前に毎回`__snapshots__`フォルダを削除しなければいけない？？
  - 今回の X を丁に変更した後のスナップショットテストでは、毎回そうするのが正しい？（なんかもっと良い方法がある気がしたが。。）今回は old_snapshots フォルダに X と O の時のスナップショットを移動したが、そういう作業を手作業でやらなければスナップショットの履歴は管理できないのか？
  - 回答 
    - 過去のスナップショットを貯めたことはなく、直前のスナップショットとのみ比べている。それは、スナップショットが他のテストを代替するものではなく、おまけのようなものなので、そこまで信頼していないため。スナップショットは、開発者のリテラシーに左右される。
    - 例えば、上手くいかないために開発者がスナップショットを一旦全て削除しまった場合、もし、それでレビューがとおり、マージしてしまったら、その瞬間にスナップショットは破綻してしまう。
    - 過去のスナップショットを残す場合、Github Actionsなどで、S3 にスナップショットを投げるなどはできるかもしれないが、そこまではやったことはない。
    - Chromatic(https://www.chromatic.com/)で過去の成果物を残す際、無料プランでは消えてしまうかもしれないが、有料プランでは残せる。（一番高いプランであれば、ヒストリー機能がある模様）

- 比較するスナップショットを選択することはできないのか？そういうニーズはありそうだが。diff コマンドみたいに。（未調査）
- storybook とスナップショットテストと jest の関係が理解できていない。
  - storybook は UI コンポーネントの管理、スナップショットテストはアプリの内部状態のリグレッションテスト、jest は単体テストなイメージでそれぞれ目的が別な気もするが。。jest でスナップショットテストをするというのがよくわからない。（未調査）
  - storyshots がなんなのか理解できていないせい？
  - 参考
    - [Storybook による UI & Unit Testing のススメ](https://engineering.mercari.com/blog/entry/2018-12-19-123834/)
- snapshot や storybook をデフォルトのまま導入しているうちに、フォルダ構成が混沌としてきた。src の中には本番コード以外は含めないイメージなので、そこに storybook や snapshot が含まれてしまっているのは良くないディレクトリ構造な気がする。（まず本番コードもコンポーネントごとに別ファイルに分ける必要もあるが、、）（未調査）
- スナップショットテストは画面表示に関するテストが中心のイメージですが、実務でそれ以外のこのテストを採用するユースケースはあるでしょうか？
  （コンパイルメッセージやログなどのスナップショットなどテストしたりしているのでしょうか）
  - jest では、console メッセージまでテストで見ていることもあるようですが、自分はやったことはなかったです。

- テストコード（今回だとstories.jsやtest.js）も本番コードと同ディレクトリに含めている場合、実際のプロジェクトではどのようにリリース対象コードのみを抽出しているのでしょうか（webpackの設定などで除外している？）
  - 回答
    - entry pointに指定したファイルからimportしたファイルが全てまとめられるので(create-react-appだとデフォルトでsrc/indexにimportしたファイルがまとめてビルドされる)、本番のコードが書かれたファイル内で、stories.jsやtest.jsをimportしない限り、気にする必要はなさそう
    - 実務でPrAhaはNext.jsを使用している。Next.jsでは裏でWebpackが動いており、Productionビルド時にrootからimport文を辿って、ビルドにどこまで含めるべきかを判断している。
    - そのため、明示的にimport文に指定しない限りは、ビルドに含まれない。
    - 注意点として、ダイナミックインポート（実行時にパスが決まる）を使用すると、ドメイン配下の全てのファイルをバンドルしてしまうので、ドメイン配下のテストコードも含まれる場合がある。
    - 上記より「import文に書かない」且つ「ダイナミックインポートをしない」ければ、基本的にはテストコードが含まれることはない。
    - ただ、どうしても含まれてしまう場合は、(Next.jsであれば)Next.configのwebpack設定でファイルを除外することになる。

## 参考

- [スナップショットテスト実戦投入 / Practical Snapshot Testing](https://speakerdeck.com/imaizume/practical-snapshot-testing)→ かなりわかりやすい（途中から iOS でのスナップショットテストツールの話）
- [Snapshot Testing: Benefits and Drawbacks](https://www.sitepen.com/blog/snapshot-testing-benefits-and-drawbacks#:~:text=Snapshot%20testing%20is%20a%20type,from%20unit%20and%20functional%20tests.)
- [Jest 14.0: React Tree Snapshot Testing](https://jestjs.io/blog/2016/07/27/jest-14.html)
- [ZOZOTOWN iOS にスナップショットテストを導入して開発速度を劇的に向上させた話](https://techblog.zozo.com/entry/ios_snapshottest)
- [Snapshot Testing](https://jestjs.io/docs/ja/snapshot-testing)
- [メルペイ iOS にスナップショットテストを導入した話](https://engineering.mercari.com/blog/entry/ios-snapshot-test-case/)
- [Pros and cons of Jest snapshot testing with some useful tips](https://tsh.io/blog/pros-and-cons-of-jest-snapshot-tests/)
